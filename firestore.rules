
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /sessions/{sessionId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && 
                       request.resource.data.adminUid == request.auth.uid &&
                       request.resource.data.likeClicks == 0 &&
                       request.resource.data.dislikeClicks == 0 &&
                       request.resource.data.isRoundActive == true &&
                       request.resource.data.sessionEnded == false; // Ensure sessionEnded is false on create

      allow update: if request.auth != null &&
                       // Admin specific actions
                       (
                         resource.data.adminUid == request.auth.uid &&
                         (
                           // Action: Toggle round (isRoundActive) OR Clear scores (likeClicks/dislikeClicks to 0)
                           (
                             (request.resource.data.isRoundActive != resource.data.isRoundActive || // isRoundActive is being changed
                              (request.resource.data.likeClicks == 0 && request.resource.data.dislikeClicks == 0) // scores are being cleared
                             ) &&
                             // These fields MUST NOT change during these specific admin actions unless explicitly part of the action
                             request.resource.data.adminUid == resource.data.adminUid &&
                             request.resource.data.sessionEnded == resource.data.sessionEnded && // sessionEnded must remain unchanged
                             // If scores are cleared, isRoundActive must remain unchanged by this specific rule path
                             (request.resource.data.likeClicks == 0 && request.resource.data.dislikeClicks == 0 ? request.resource.data.isRoundActive == resource.data.isRoundActive : true) &&
                             // If isRoundActive is toggled, scores must remain unchanged by this specific rule path
                             (request.resource.data.isRoundActive != resource.data.isRoundActive ? (request.resource.data.likeClicks == resource.data.likeClicks && request.resource.data.dislikeClicks == resource.data.dislikeClicks) : true)
                           ) ||
                           // Action: End session
                           (
                             request.resource.data.sessionEnded == true &&
                             request.resource.data.isRoundActive == false && // Admin explicitly sets isRoundActive to false when ending
                             resource.data.sessionEnded == false && // Can only end a session that is not already ended
                             // These fields MUST NOT change during 'end session' action
                             request.resource.data.adminUid == resource.data.adminUid &&
                             request.resource.data.likeClicks == resource.data.likeClicks &&
                             request.resource.data.dislikeClicks == resource.data.dislikeClicks
                           )
                         )
                       ) ||
                       // Player vote action
                       (
                         resource.data.isRoundActive == true && // Round must be active
                         resource.data.sessionEnded == false && // Session must not be ended
                         (
                           // Player is incrementing likeClicks or dislikeClicks by 1
                           (request.resource.data.likeClicks == resource.data.likeClicks + 1 && request.resource.data.dislikeClicks == resource.data.dislikeClicks) ||
                           (request.resource.data.dislikeClicks == resource.data.dislikeClicks + 1 && request.resource.data.likeClicks == resource.data.likeClicks)
                         ) &&
                         // These fields MUST NOT be changed by a player vote
                         request.resource.data.adminUid == resource.data.adminUid &&
                         request.resource.data.isRoundActive == resource.data.isRoundActive && // Player cannot change isRoundActive
                         request.resource.data.sessionEnded == resource.data.sessionEnded    // Player cannot change sessionEnded
                       );
      
      // Delete is currently not used by the "End Session" button (it uses a soft delete via sessionEnded field)
      // Keeping this rule if direct deletion is ever needed by an admin.
      allow delete: if request.auth != null && resource.data.adminUid == request.auth.uid;
    }
  }
}
